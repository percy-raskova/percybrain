#!/bin/bash
#
# OVIWrite Pre-push Hook
# Runs Layer 1-3 validation before allowing push
#

# Allow skip with environment variable
if [ "$SKIP_VALIDATION" = "1" ]; then
  echo "‚è≠Ô∏è  Skipping validation (SKIP_VALIDATION=1)"
  exit 0
fi

# Get script directory
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
SCRIPTS_DIR="$REPO_ROOT/scripts"

echo "üîç Running pre-push validation (includes startup test)..."
echo ""

# Check if scripts exist
if [ ! -f "$SCRIPTS_DIR/validate.sh" ]; then
  echo "‚ö†Ô∏è  Validation scripts not found"
  echo "   Run: ./scripts/setup-dev-env.sh"
  exit 0
fi

# Run full validation (Layer 1-3)
# Note: Using --full flag to include startup test
if ! "$SCRIPTS_DIR/validate.sh" --full; then
  echo ""
  echo "‚ùå Pre-push validation failed"
  echo ""
  echo "Fix errors above or skip with:"
  echo "  SKIP_VALIDATION=1 git push"
  echo ""
  echo "Or push without running hook:"
  echo "  git push --no-verify"
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ Pre-push validation passed"
exit 0
