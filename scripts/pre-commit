#!/bin/bash
#
# OVIWrite Pre-commit Hook
# Runs Layer 1-2 validation before allowing commit
#

# Allow skip with environment variable
if [ "$SKIP_VALIDATION" = "1" ]; then
  echo "‚è≠Ô∏è  Skipping validation (SKIP_VALIDATION=1)"
  exit 0
fi

# Get script directory
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
SCRIPTS_DIR="$REPO_ROOT/scripts"

echo "üîç Running pre-commit validation..."
echo ""

# Check if scripts exist
if [ ! -f "$SCRIPTS_DIR/validate-layer1.sh" ]; then
  echo "‚ö†Ô∏è  Validation scripts not found"
  echo "   Run: ./scripts/setup-dev-env.sh"
  exit 0
fi

# Run Layer 1 validation
if ! "$SCRIPTS_DIR/validate-layer1.sh"; then
  echo ""
  echo "‚ùå Pre-commit validation failed"
  echo ""
  echo "Fix errors above or skip with:"
  echo "  SKIP_VALIDATION=1 git commit"
  echo ""
  exit 1
fi

# Run Layer 2 validation
if ! nvim --headless -l "$SCRIPTS_DIR/validate-layer2.lua"; then
  echo ""
  echo "‚ùå Pre-commit validation failed"
  echo ""
  echo "Fix errors above or skip with:"
  echo "  SKIP_VALIDATION=1 git commit"
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ Pre-commit validation passed"
exit 0
